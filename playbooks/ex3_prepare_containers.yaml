---
- name: Prepare Docker environment for Gestion Abonnements
  hosts: serveurs
  become: yes

  vars:
    app_path: /root/app
    jar_name: gestion-abonnements-1.0-SNAPSHOT.jar

  tasks:

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_path }}"
        state: directory
        mode: '0755'

    - name: Create Dockerfile
      ansible.builtin.copy:
        dest: "{{ app_path }}/Dockerfile"
        content: |
          FROM eclipse-temurin:21-jdk-alpine
          WORKDIR /app
          COPY target/{{ jar_name }} app.jar
          EXPOSE 4567
          CMD ["java", "-jar", "app.jar", "api"]

    - name: Create docker-compose.yml
      ansible.builtin.copy:
        dest: "{{ app_path }}/docker-compose.yml"
        content: |
          version: '3.8'

          services:
            backend:
              build: .
              container_name: gestion_backend
              ports:
                - "4567:4567"
              volumes:
                - ./data:/app/data
              restart: unless-stopped
---
- name: Prepare Docker environment for Gestion Abonnements
  hosts: serveurs
  become: yes

  vars:
    app_path: /root/app
    jar_name: gestion-abonnements-1.0-SNAPSHOT.jar

  tasks:

    - name: Create application directory
      ansible.builtin.file:
        path: "{{ app_path }}"
        state: directory
        mode: '0755'

    - name: Create Dockerfile
      ansible.builtin.copy:
        dest: "{{ app_path }}/Dockerfile"
        content: |
          FROM eclipse-temurin:21-jdk-alpine
          WORKDIR /app
          COPY target/{{ jar_name }} app.jar
          EXPOSE 4567
          CMD ["java", "-jar", "app.jar", "api"]

    - name: Create docker-compose.yml
      ansible.builtin.copy:
        dest: "{{ app_path }}/docker-compose.yml"
        content: |
          version: '3.8'

          services:
            backend:
              build: .
              container_name: gestion_backend
              ports:
                - "4567:4567"
              volumes:
                - ./data:/app/data
              restart: unless-stopped

